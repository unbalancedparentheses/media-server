<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Media Server</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127916;</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#09090f;--surface:#111118;--surface2:#16161f;--border:#1e1e2a;--border-hover:#2a2a3a;
    --text:#e8e8ed;--text2:#8888a0;--text3:#55556a;
    --gold:#c8a44e;--gold-dim:#c8a44e18;--gold-med:#c8a44e30;
    --teal:#5eead4;--teal-dim:#5eead410;
    --green:#4ade80;--green-dim:#4ade8018;
    --blue:#60a5fa;--blue-dim:#60a5fa18;
    --red:#f87171;--red-dim:#f8717118;
    --amber:#fbbf24;--amber-dim:#fbbf2418;
    --purple:#a78bfa;--purple-dim:#a78bfa18;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Outfit',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}

  /* Subtle grain overlay */
  body::after{content:'';position:fixed;inset:0;pointer-events:none;opacity:0.025;z-index:9999;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}

  /* Custom scrollbar */
  ::-webkit-scrollbar{width:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:var(--border-hover)}

  /* Header */
  .header{padding:2.5rem 2.5rem 2rem;border-bottom:1px solid var(--border);position:relative;overflow:hidden}
  .header::before{content:'';position:absolute;top:-50%;right:-10%;width:400px;height:400px;background:radial-gradient(circle,var(--gold-dim) 0%,transparent 70%);pointer-events:none}
  .header-inner{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;position:relative}
  .header h1{font-size:1.5rem;font-weight:700;letter-spacing:-0.03em;color:var(--text)}
  .header h1 span{color:var(--gold);font-weight:700}
  .header-sub{color:var(--text3);font-size:0.8rem;margin-top:0.35rem;font-weight:400;letter-spacing:0.02em}
  .admin-link{color:var(--text3);font-size:0.75rem;font-weight:500;text-decoration:none;border:1px solid var(--border);padding:0.4rem 0.9rem;border-radius:6px;transition:all 0.25s ease;letter-spacing:0.03em;text-transform:uppercase}
  .admin-link:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}

  .content{max-width:1200px;margin:0 auto;padding:2rem 2.5rem 4rem}
  .section{margin-bottom:2.5rem}

  /* Section titles with line */
  .section-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.14em;color:var(--text3);margin-bottom:1rem;padding-left:0.5rem;display:flex;align-items:center;gap:1rem}
  .section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

  /* Service grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:0.85rem}

  /* Cards with stagger animation */
  @keyframes cardIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .card{display:flex;align-items:center;gap:1rem;padding:1.1rem 1.3rem;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text);text-decoration:none;transition:all 0.25s ease;position:relative;overflow:hidden;animation:cardIn 0.4s ease both}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border-hover),transparent);transition:background 0.25s ease}
  .card:hover{background:var(--surface2);border-color:var(--border-hover);transform:translateY(-2px);box-shadow:0 8px 25px -5px rgba(0,0,0,0.4)}
  .card:hover::before{background:linear-gradient(90deg,transparent,var(--gold),transparent)}

  .icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;transition:transform 0.2s ease}
  .card:hover .icon{transform:scale(1.05)}
  .card-info{flex:1;min-width:0}
  .card-name{font-size:0.9rem;font-weight:600;letter-spacing:-0.01em}
  .card-desc{font-size:0.72rem;color:var(--text2);margin-top:0.2rem;font-weight:400}
  .card-port{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--gold);font-weight:500;margin-top:0.25rem;opacity:0.7}

  /* Health dots with pulse */
  .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:var(--border);transition:all 0.4s ease}
  .dot.up{background:var(--green);box-shadow:0 0 8px var(--green-dim)}
  .dot.down{background:var(--red);box-shadow:0 0 8px var(--red-dim)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  .dot.up{animation:pulse 3s ease-in-out infinite}

  /* Category icon colors */
  .cat-media .icon{background:linear-gradient(135deg,#c8a44e15,#c8a44e08);color:var(--gold)}
  .cat-download .icon{background:linear-gradient(135deg,#5eead415,#5eead408);color:var(--teal)}
  .cat-tools .icon{background:linear-gradient(135deg,#a78bfa15,#a78bfa08);color:var(--purple)}

  /* Downloads panel */
  .dl-panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .dl-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.3rem;border-bottom:1px solid var(--border)}
  .dl-header-title{font-size:0.85rem;font-weight:600;letter-spacing:-0.01em}
  .dl-stats{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text2);display:flex;gap:1rem}
  .dl-stats .down{color:var(--green)}
  .dl-stats .up{color:var(--blue)}
  .dl-empty{padding:2.5rem;text-align:center;color:var(--text3);font-size:0.82rem;font-weight:400}
  .dl-item{display:flex;align-items:center;gap:0.9rem;padding:0.8rem 1.3rem;border-bottom:1px solid #12121a;transition:background 0.15s}
  .dl-item:last-child{border-bottom:none}
  .dl-item:hover{background:var(--surface2)}
  .dl-icon{font-size:0.85rem;flex-shrink:0;width:20px;text-align:center}
  .dl-icon.downloading{color:var(--green)}
  .dl-icon.seeding{color:var(--blue)}
  .dl-icon.stalled{color:var(--amber)}
  .dl-icon.paused{color:var(--text3)}
  .dl-info{flex:1;min-width:0}
  .dl-name{font-size:0.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dl-meta{display:flex;flex-wrap:wrap;gap:0.4rem 0.9rem;font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text3);margin-top:0.3rem}
  .dl-bar-wrap{width:100%;height:3px;background:var(--border);border-radius:2px;margin-top:0.35rem;overflow:hidden}
  .dl-bar{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--teal));transition:width 0.5s ease}
  .dl-bar.done{background:linear-gradient(90deg,var(--blue),var(--purple))}
  .dl-right{text-align:right;flex-shrink:0;min-width:55px}
  .dl-pct{font-family:'JetBrains Mono',monospace;font-size:0.8rem;font-weight:500}
  .dl-speed{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--text3);margin-top:0.2rem}
  .dl-eta{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--text3);margin-top:0.1rem}

  /* Widget grid */
  .widget-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.85rem}
  @media(max-width:768px){.widget-grid{grid-template-columns:1fr}}

  /* Widget panel */
  .w-panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .w-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.3rem;border-bottom:1px solid var(--border)}
  .w-header-title{font-size:0.85rem;font-weight:600;letter-spacing:-0.01em}
  .w-header-sub{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text3)}
  .w-empty{padding:2.5rem;text-align:center;color:var(--text3);font-size:0.82rem}
  .w-list{max-height:340px;overflow-y:auto}
  .w-item{display:flex;align-items:center;gap:0.9rem;padding:0.7rem 1.3rem;border-bottom:1px solid #12121a;transition:background 0.15s}
  .w-item:last-child{border-bottom:none}
  .w-item:hover{background:var(--surface2)}
  .w-item-icon{font-size:0.85rem;flex-shrink:0;width:20px;text-align:center}
  .w-item-info{flex:1;min-width:0}
  .w-item-title{font-size:0.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .w-item-sub{font-size:0.65rem;color:var(--text2);margin-top:0.2rem;font-weight:400}
  .w-item-right{flex-shrink:0;text-align:right}

  /* Calendar */
  .cal-date{font-family:'JetBrains Mono',monospace;font-size:0.6rem;font-weight:500;color:var(--text3);padding:0.6rem 1.3rem 0.35rem;text-transform:uppercase;letter-spacing:0.08em;background:#0c0c14;border-bottom:1px solid #12121a}
  .cal-ep{color:var(--green)}
  .cal-movie{color:var(--gold)}

  /* Badges */
  .badge{font-family:'JetBrains Mono',monospace;font-size:0.55rem;font-weight:500;padding:0.2rem 0.55rem;border-radius:5px;text-transform:uppercase;letter-spacing:0.04em}
  .badge-pending{background:var(--amber-dim);color:var(--amber);border:1px solid #fbbf2415}
  .badge-approved{background:var(--blue-dim);color:var(--blue);border:1px solid #60a5fa15}
  .badge-available{background:var(--green-dim);color:var(--green);border:1px solid #4ade8015}
  .badge-declined{background:var(--red-dim);color:var(--red);border:1px solid #f8717115}

  /* Disk gauge */
  .disk-gauge{padding:1.5rem 1.3rem;text-align:center}
  .disk-bar-wrap{width:100%;height:8px;background:var(--border);border-radius:4px;margin:1rem 0;overflow:hidden}
  .disk-bar{height:100%;border-radius:4px;transition:width 0.5s ease}
  .disk-bar.ok{background:linear-gradient(90deg,var(--green),var(--teal))}
  .disk-bar.warn{background:linear-gradient(90deg,var(--amber),#f59e0b)}
  .disk-bar.crit{background:linear-gradient(90deg,var(--red),#ef4444)}
  .disk-label{font-family:'JetBrains Mono',monospace;font-size:0.85rem;font-weight:500}
  .disk-sub{font-size:0.72rem;color:var(--text2);margin-top:0.35rem;font-weight:400}

  /* Responsive */
  @media(max-width:600px){
    .header{padding:1.8rem 1.5rem 1.4rem}
    .content{padding:1.5rem 1.5rem 3rem}
    .header-inner{flex-direction:column;align-items:flex-start;gap:0.8rem}
  }
</style></head>
<body>
  <div class="header">
    <div class="header-inner">
      <div>
        <h1><span>Media</span> Server</h1>
        <div class="header-sub">Service dashboard</div>
      </div>
      <a href="/admin.html" class="admin-link">Admin</a>
    </div>
  </div>
  <div class="content">
    <div id="app"></div>

    <!-- Downloads: qBittorrent -->
    <div class="section">
      <div class="section-title">Active Transfers</div>
      <div class="dl-panel">
        <div class="dl-header">
          <div class="dl-header-title">qBittorrent</div>
          <div class="dl-stats" id="dl-stats"></div>
        </div>
        <div id="dl-list"><div class="dl-empty">Loading...</div></div>
      </div>
    </div>

    <!-- Downloads: SABnzbd -->
    <div class="section">
      <div class="dl-panel">
        <div class="dl-header">
          <div class="dl-header-title">SABnzbd</div>
          <div class="dl-stats" id="sab-stats"></div>
        </div>
        <div id="sab-list"><div class="dl-empty">Loading...</div></div>
      </div>
    </div>

    <!-- Two-column widget grid -->
    <div class="section">
      <div class="section-title">Activity</div>
      <div class="widget-grid">

        <!-- Calendar -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Upcoming</div>
            <div class="w-header-sub" id="cal-sub"></div>
          </div>
          <div class="w-list" id="cal-list"><div class="w-empty">Loading...</div></div>
        </div>

        <!-- Recently Added -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Recently Added</div>
            <div class="w-header-sub" id="recent-sub"></div>
          </div>
          <div class="w-list" id="recent-list"><div class="w-empty">Loading...</div></div>
        </div>

        <!-- Jellyseerr Requests -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Requests</div>
            <div class="w-header-sub" id="req-sub"></div>
          </div>
          <div class="w-list" id="req-list"><div class="w-empty">Loading...</div></div>
        </div>

        <!-- Disk Space -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Disk Space</div>
            <div class="w-header-sub" id="disk-sub"></div>
          </div>
          <div id="disk-content"><div class="w-empty">Loading...</div></div>
        </div>

      </div>
    </div>
  </div>
  <script>
    var h=location.hostname;
    var icons={
      Jellyseerr:'\uD83C\uDFAC',Jellyfin:'\u25B6\uFE0F',
      Sonarr:'\uD83D\uDCFA','Sonarr Anime':'\uD83C\uDF1F',
      Radarr:'\uD83C\uDFA5',Lidarr:'\uD83C\uDFB5',LazyLibrarian:'\uD83D\uDCDA',
      Prowlarr:'\uD83D\uDD0D',Bazarr:'\uD83D\uDCAC',Autobrr:'\u26A1',
      qBittorrent:'\u2B07\uFE0F',SABnzbd:'\uD83D\uDCE5',
      Navidrome:'\uD83C\uDFB6',Kavita:'\uD83D\uDCD6',TubeArchivist:'\uD83D\uDCF9',Immich:'\uD83D\uDCF7',Tdarr:'\uD83D\uDD04',
      Ollama:'\uD83E\uDDE0','Open WebUI':'\uD83D\uDCAC',Dozzle:'\uD83D\uDCDC',Beszel:'\uD83D\uDCCA',Scrutiny:'\uD83D\uDCBF',
      Gitea:'\uD83D\uDCBB','Uptime Kuma':'\uD83D\uDFE2'
    };
    var sections=[
      ["Watch & Request","cat-media",[
        [5055,"Jellyseerr","Request movies & TV"],
        [8096,"Jellyfin","Stream your library"],
        [4533,"Navidrome","Stream your music"],
        [5001,"Kavita","Read books & comics"],
        [8000,"TubeArchivist","YouTube archive"]
      ]],
      ["Downloads","cat-download",[
        [8081,"qBittorrent","Torrent client"],
        [8080,"SABnzbd","Usenet client"]
      ]],
      ["AI","cat-tools",[
        [3100,"Open WebUI","Chat with local LLMs"]
      ]],
      ["Photos","cat-tools",[
        [2283,"Immich","Photo management"]
      ]]
    ];

    // Build entire service grid as one string, assign once
    var gridHtml='';
    var allServices=[];
    var cardIdx=0;
    sections.forEach(function(sec){
      gridHtml+='<div class="section"><div class="section-title">'+sec[0]+'</div><div class="grid">';
      sec[2].forEach(function(s){
        var ico=icons[s[1]]||'\u25CF';
        gridHtml+='<a href="http://'+h+':'+s[0]+'" class="card '+sec[1]+'" style="animation-delay:'+(cardIdx*0.05)+'s">'
          +'<div class="icon">'+ico+'</div>'
          +'<div class="card-info"><div class="card-name">'+s[1]+'</div>'
          +'<div class="card-desc">'+s[2]+'</div>'
          +'<div class="card-port">:'+s[0]+'</div></div>'
          +'<div class="dot" id="d'+s[0]+'"></div></a>';
        allServices.push(s[0]);
        cardIdx++;
      });
      gridHtml+='</div></div>';
    });
    document.getElementById("app").innerHTML=gridHtml;

    // Health checks — run on load and every 30s
    function checkHealth(){
      allServices.forEach(function(port){
        var d=document.getElementById("d"+port);
        if(!d)return;
        fetch("http://"+h+":"+port,{mode:"no-cors",signal:AbortSignal.timeout(3000)})
          .then(function(){d.className="dot up"})
          .catch(function(){d.className="dot down"});
      });
    }
    checkHealth();
    setInterval(checkHealth,30000);

    // ── Shared helpers ──
    function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
    function fmtSize(b){
      if(b<1024)return b+"B";
      if(b<1048576)return(b/1024).toFixed(1)+" KB";
      if(b<1073741824)return(b/1048576).toFixed(1)+" MB";
      return(b/1073741824).toFixed(1)+" GB";
    }
    function fmtSpeed(b){
      if(b<1024)return b+" B/s";
      if(b<1048576)return(b/1024).toFixed(0)+" KB/s";
      return(b/1048576).toFixed(1)+" MB/s";
    }
    function fmtEta(secs){
      if(secs<=0||secs>=8640000)return'';
      if(secs<60)return secs+'s';
      if(secs<3600)return Math.floor(secs/60)+'m';
      if(secs<86400)return Math.floor(secs/3600)+'h '+Math.floor((secs%3600)/60)+'m';
      return Math.floor(secs/86400)+'d '+Math.floor((secs%86400)/3600)+'h';
    }
    function isoDate(d){return d.toISOString().split('T')[0];}
    function shortDate(s){
      var d=new Date(s);
      var today=new Date();today.setHours(0,0,0,0);
      var diff=Math.floor((d-today)/86400000);
      if(diff===0)return'Today';
      if(diff===1)return'Tomorrow';
      return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
    }

    // ── qBittorrent Downloads ──
    function stateIcon(st){
      if(st==="downloading"||st==="forcedDL"||st==="metaDL")return['downloading','\u25BC'];
      if(st==="uploading"||st==="forcedUP"||st==="stalledUP"||st==="queuedUP")return['seeding','\u25B2'];
      if(st==="stalledDL"||st==="checkingDL")return['stalled','\u25CF'];
      if(st==="pausedDL"||st==="pausedUP")return['paused','\u275A\u275A'];
      return['stalled','\u25CF'];
    }
    function stateLabel(st){
      if(st==="downloading"||st==="forcedDL")return"Downloading";
      if(st==="metaDL")return"Metadata";
      if(st==="uploading"||st==="forcedUP")return"Seeding";
      if(st==="stalledUP"||st==="queuedUP")return"Seeding (idle)";
      if(st==="stalledDL")return"Stalled";
      if(st==="pausedDL")return"Paused";
      if(st==="pausedUP")return"Complete";
      if(st==="checkingDL"||st==="checkingUP"||st==="checkingResumeData")return"Checking";
      if(st==="queuedDL")return"Queued";
      if(st==="moving")return"Moving";
      return st;
    }
    function refreshDownloads(){
      fetch("/api/qbt/torrents/info").then(function(r){return r.json()}).then(function(torrents){
        var totalDown=0,totalUp=0;
        torrents.forEach(function(t){totalDown+=t.dlspeed;totalUp+=t.upspeed;});
        var statsEl=document.getElementById("dl-stats");
        statsEl.innerHTML='<span class="down">\u25BC '+fmtSpeed(totalDown)+'</span><span class="up">\u25B2 '+fmtSpeed(totalUp)+'</span><span>'+torrents.length+' torrent'+(torrents.length!==1?'s':'')+'</span>';
        var list=document.getElementById("dl-list");
        if(!torrents.length){list.innerHTML='<div class="dl-empty">No active torrents</div>';return;}
        torrents.sort(function(a,b){
          var aD=a.state.indexOf("DL")!==-1||a.state==="downloading"?0:1;
          var bD=b.state.indexOf("DL")!==-1||b.state==="downloading"?0:1;
          if(aD!==bD)return aD-bD;
          return a.progress-b.progress;
        });
        var html="";
        torrents.forEach(function(t){
          var si=stateIcon(t.state);
          var pct=Math.floor(t.progress*100);
          var barClass=pct>=100?"dl-bar done":"dl-bar";
          var speedTxt="";
          if(t.dlspeed>0)speedTxt="\u25BC "+fmtSpeed(t.dlspeed);
          else if(t.upspeed>0)speedTxt="\u25B2 "+fmtSpeed(t.upspeed);
          var eta=t.eta?fmtEta(t.eta):'';
          html+='<div class="dl-item">';
          html+='<div class="dl-icon '+si[0]+'">'+si[1]+'</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(t.name)+'">'+esc(t.name)+'</div>';
          html+='<div class="dl-meta"><span>'+stateLabel(t.state)+'</span><span>'+fmtSize(t.size)+'</span><span>'+t.num_seeds+' seeds / '+t.num_leechs+' peers</span>'+(t.category?'<span>'+esc(t.category)+'</span>':'')+'</div>';
          html+='<div class="dl-bar-wrap"><div class="'+barClass+'" style="width:'+pct+'%"></div></div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct">'+pct+'%</div><div class="dl-speed">'+speedTxt+'</div>'+(eta?'<div class="dl-eta">'+eta+'</div>':'')+'</div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("dl-list").innerHTML='<div class="dl-empty">Cannot connect to qBittorrent</div>';
      });
    }
    refreshDownloads();
    setInterval(refreshDownloads,5000);

    // ── SABnzbd Downloads ──
    function refreshSab(){
      Promise.all([
        fetch('/api/sabnzbd/?mode=queue&output=json').then(function(r){return r.json()}),
        fetch('/api/sabnzbd/?mode=history&output=json&limit=5').then(function(r){return r.json()})
      ]).then(function(results){
        var queue=results[0].queue||{};
        var history=results[1].history||{};
        var slots=queue.slots||[];
        var histSlots=(history.slots||[]).slice(0,5);
        var statsEl=document.getElementById("sab-stats");
        var speed=queue.speed||'0';
        var left=queue.timeleft||'';
        statsEl.innerHTML='<span class="down">\u25BC '+esc(speed)+'</span>'+(left?'<span>ETA: '+esc(left)+'</span>':'')+'<span>'+slots.length+' active</span>';
        var list=document.getElementById("sab-list");
        if(!slots.length&&!histSlots.length){list.innerHTML='<div class="dl-empty">No active downloads</div>';return;}
        var html='';
        slots.forEach(function(s){
          var pct=Math.round(parseFloat(s.percentage)||0);
          html+='<div class="dl-item">';
          html+='<div class="dl-icon downloading">\u25BC</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(s.filename)+'">'+esc(s.filename)+'</div>';
          html+='<div class="dl-meta"><span>Downloading</span><span>'+esc(s.size)+'</span>'+(s.cat?'<span>'+esc(s.cat)+'</span>':'')+'</div>';
          html+='<div class="dl-bar-wrap"><div class="dl-bar" style="width:'+pct+'%"></div></div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct">'+pct+'%</div><div class="dl-speed">'+esc(s.timeleft||'')+'</div></div>';
          html+='</div>';
        });
        histSlots.forEach(function(s){
          var ok=s.status==='Completed';
          html+='<div class="dl-item">';
          html+='<div class="dl-icon '+(ok?'seeding':'stalled')+'">'+(ok?'\u2714':'\u2716')+'</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(s.name)+'">'+esc(s.name)+'</div>';
          html+='<div class="dl-meta"><span>'+esc(s.status)+'</span><span>'+esc(s.size)+'</span>'+(s.category?'<span>'+esc(s.category)+'</span>':'')+'</div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct" style="color:'+(ok?'var(--green)':'var(--red)')+'">'+(ok?'Done':'Fail')+'</div></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("sab-list").innerHTML='<div class="dl-empty">Cannot connect to SABnzbd</div>';
      });
    }
    refreshSab();
    setInterval(refreshSab,5000);

    // ── Calendar (Sonarr + Sonarr Anime + Radarr) ──
    function refreshCalendar(){
      var today=new Date();
      var end7=new Date(today);end7.setDate(end7.getDate()+7);
      var end90=new Date(today);end90.setDate(end90.getDate()+90);
      var start=isoDate(today),endW=isoDate(end7),endM=isoDate(end90);
      Promise.all([
        fetch('/api/sonarr/calendar?start='+start+'&end='+endW).then(function(r){return r.json()}).catch(function(){return[]}),
        fetch('/api/sonarr-anime/calendar?start='+start+'&end='+endW).then(function(r){return r.json()}).catch(function(){return[]}),
        fetch('/api/radarr/calendar?start='+start+'&end='+endM).then(function(r){return r.json()}).catch(function(){return[]})
      ]).then(function(results){
        var items=[];
        results[0].forEach(function(ep){
          items.push({date:ep.airDateUtc||ep.airDate||'',title:ep.series?ep.series.title:'Unknown',sub:'S'+String(ep.seasonNumber).padStart(2,'0')+'E'+String(ep.episodeNumber).padStart(2,'0')+' - '+(ep.title||''),type:'ep'});
        });
        results[1].forEach(function(ep){
          items.push({date:ep.airDateUtc||ep.airDate||'',title:ep.series?ep.series.title:'Unknown',sub:'S'+String(ep.seasonNumber).padStart(2,'0')+'E'+String(ep.episodeNumber).padStart(2,'0')+' - '+(ep.title||''),type:'ep'});
        });
        results[2].forEach(function(m){
          items.push({date:m.inCinemas||m.digitalRelease||m.physicalRelease||'',title:m.title||'Unknown',sub:m.year?String(m.year):'',type:'movie'});
        });
        items.sort(function(a,b){return(a.date||'').localeCompare(b.date||'')});
        document.getElementById("cal-sub").textContent=items.length+' upcoming';
        var list=document.getElementById("cal-list");
        if(!items.length){list.innerHTML='<div class="w-empty">Nothing upcoming</div>';return;}
        var html='',lastDate='';
        items.forEach(function(it){
          var d=it.date?it.date.split('T')[0]:'';
          if(d!==lastDate){html+='<div class="cal-date">'+shortDate(d)+'</div>';lastDate=d;}
          html+='<div class="w-item">';
          html+='<div class="w-item-icon '+(it.type==='ep'?'cal-ep':'cal-movie')+'">'+(it.type==='ep'?'\uD83D\uDCFA':'\uD83C\uDFA5')+'</div>';
          html+='<div class="w-item-info"><div class="w-item-title">'+esc(it.title)+'</div><div class="w-item-sub">'+esc(it.sub)+'</div></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("cal-list").innerHTML='<div class="w-empty">Cannot load calendar</div>';
      });
    }
    refreshCalendar();
    setInterval(refreshCalendar,300000);

    // ── Recently Added (Jellyfin) ──
    function refreshRecent(){
      fetch('/api/jellyfin/Items?SortBy=DateCreated&SortOrder=Descending&Limit=10&Recursive=true&IncludeItemTypes=Movie,Series&Fields=DateCreated').then(function(r){return r.json()}).then(function(data){
        var items=(data&&data.Items)||[];
        document.getElementById("recent-sub").textContent=items.length+' items';
        var list=document.getElementById("recent-list");
        if(!items.length){list.innerHTML='<div class="w-empty">No recent media</div>';return;}
        var html='';
        items.forEach(function(it){
          var type=it.Type||'';
          var ico=type==='Movie'?'\uD83C\uDFA5':type==='Series'?'\uD83D\uDCFA':'\uD83C\uDFB5';
          var sub=type;
          if(it.ProductionYear)sub+=' ('+it.ProductionYear+')';
          if(it.DateCreated){
            var d=new Date(it.DateCreated);
            sub+=' - added '+d.toLocaleDateString();
          }
          html+='<div class="w-item">';
          html+='<div class="w-item-icon">'+ico+'</div>';
          html+='<div class="w-item-info"><div class="w-item-title">'+esc(it.Name||'Unknown')+'</div><div class="w-item-sub">'+esc(sub)+'</div></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("recent-list").innerHTML='<div class="w-empty">Cannot connect to Jellyfin</div>';
      });
    }
    refreshRecent();
    setInterval(refreshRecent,120000);

    // ── Jellyseerr Requests ──
    function refreshRequests(){
      fetch('/api/jellyseerr/request?take=10&sort=added&skip=0').then(function(r){return r.json()}).then(function(data){
        var results=data.results||[];
        document.getElementById("req-sub").textContent=(data.pageInfo?data.pageInfo.results:results.length)+' total';
        var list=document.getElementById("req-list");
        if(!results.length){list.innerHTML='<div class="w-empty">No requests</div>';return;}
        var html='';
        results.forEach(function(req){
          var media=req.media||{};
          var title=media.title||media.name||(req.type==='movie'?'Movie':'TV Show');
          if(req.type==='movie'&&req.media&&req.media.title)title=req.media.title;
          if(req.type==='tv'&&req.media&&req.media.name)title=req.media.name;
          var status=req.status;
          var badgeClass='badge-pending',badgeText='Pending';
          if(status===2){badgeClass='badge-approved';badgeText='Approved';}
          else if(status===3){badgeClass='badge-declined';badgeText='Declined';}
          if(media.status===5){badgeClass='badge-available';badgeText='Available';}
          else if(media.status===4){badgeClass='badge-approved';badgeText='Processing';}
          var ico=req.type==='movie'?'\uD83C\uDFA5':'\uD83D\uDCFA';
          var sub=req.type==='movie'?'Movie':'TV Show';
          if(req.requestedBy&&req.requestedBy.displayName)sub+=' - '+req.requestedBy.displayName;
          html+='<div class="w-item">';
          html+='<div class="w-item-icon">'+ico+'</div>';
          html+='<div class="w-item-info"><div class="w-item-title">'+esc(title)+'</div><div class="w-item-sub">'+esc(sub)+'</div></div>';
          html+='<div class="w-item-right"><span class="badge '+badgeClass+'">'+badgeText+'</span></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("req-list").innerHTML='<div class="w-empty">Cannot connect to Jellyseerr</div>';
      });
    }
    refreshRequests();
    setInterval(refreshRequests,30000);

    // ── Disk Space (via qBittorrent sync/maindata) ──
    function refreshDisk(){
      fetch('/api/qbt/sync/maindata').then(function(r){return r.json()}).then(function(data){
        var state=data.server_state||{};
        var free=state.free_space_on_disk||0;
        var el=document.getElementById("disk-content");
        var freeGB=(free/1073741824).toFixed(1);
        document.getElementById("disk-sub").textContent='Downloads drive';
        var cls='ok';
        if(free<53687091200)cls='warn';
        if(free<10737418240)cls='crit';
        el.innerHTML='<div class="disk-gauge">'
          +'<div class="disk-label">'+freeGB+' GB free</div>'
          +'<div class="disk-bar-wrap"><div class="disk-bar '+cls+'" style="width:'+Math.min(100,Math.max(5,free/1099511627776*100))+'%"></div></div>'
          +'<div class="disk-sub">'+((free<53687091200)?'Low disk space warning':'Healthy')+'</div>'
          +'</div>';
      }).catch(function(){
        document.getElementById("disk-content").innerHTML='<div class="w-empty">Cannot read disk info</div>';
      });
    }
    refreshDisk();
    setInterval(refreshDisk,60000);
  </script>
</body></html>

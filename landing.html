<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Media Server</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127916;</text></svg>">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,sans-serif;background:#0f0f1a;color:#e0e0e0;min-height:100vh}
  .header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);padding:2rem 2rem 1.5rem;border-bottom:1px solid #2a2a4a}
  .header h1{font-size:1.6rem;font-weight:700;letter-spacing:-0.02em}
  .header h1 span{color:#e94560}
  .header p{color:#7a7a9a;font-size:0.85rem;margin-top:0.3rem}
  .content{max-width:1200px;margin:0 auto;padding:1.5rem 2rem 3rem}
  .section{margin-bottom:2rem}
  .section-title{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:#7a7a9a;margin-bottom:0.75rem;padding-left:0.25rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.75rem}
  .card{display:flex;align-items:center;gap:1rem;padding:1rem 1.2rem;background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;color:#e0e0e0;text-decoration:none;transition:all 0.2s ease}
  .card:hover{background:#1e2240;border-color:#3a3a5a;transform:translateY(-1px)}
  .icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
  .card-info{flex:1;min-width:0}
  .card-name{font-size:0.95rem;font-weight:600}
  .card-desc{font-size:0.75rem;color:#7a7a9a;margin-top:0.15rem}
  .card-port{font-size:0.65rem;color:#e94560;font-weight:500;margin-top:0.2rem}
  .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#3a3a5a;transition:background 0.3s ease}
  .dot.up{background:#4ade80}
  .dot.down{background:#ef4444}
  .cat-media .icon{background:#e9456020;color:#e94560}
  .cat-manage .icon{background:#3b82f620;color:#3b82f6}
  .cat-download .icon{background:#f59e0b20;color:#f59e0b}
  .cat-tools .icon{background:#8b5cf620;color:#8b5cf6}
  /* Downloads panel */
  .dl-panel{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;overflow:hidden}
  .dl-header{display:flex;justify-content:space-between;align-items:center;padding:0.8rem 1.2rem;border-bottom:1px solid #2a2a4a}
  .dl-header-title{font-size:0.85rem;font-weight:600}
  .dl-stats{font-size:0.7rem;color:#7a7a9a}
  .dl-stats span{margin-left:1rem}
  .dl-stats .down{color:#4ade80}
  .dl-stats .up{color:#3b82f6}
  .dl-empty{padding:2rem;text-align:center;color:#4a4a6a;font-size:0.85rem}
  .dl-item{display:flex;align-items:center;gap:0.8rem;padding:0.7rem 1.2rem;border-bottom:1px solid #1f1f35}
  .dl-item:last-child{border-bottom:none}
  .dl-icon{font-size:0.9rem;flex-shrink:0;width:20px;text-align:center}
  .dl-icon.downloading{color:#4ade80}
  .dl-icon.seeding{color:#3b82f6}
  .dl-icon.stalled{color:#f59e0b}
  .dl-icon.paused{color:#7a7a9a}
  .dl-info{flex:1;min-width:0}
  .dl-name{font-size:0.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dl-meta{display:flex;flex-wrap:wrap;gap:0.5rem 1rem;font-size:0.65rem;color:#7a7a9a;margin-top:0.25rem}
  .dl-bar-wrap{width:100%;height:3px;background:#2a2a4a;border-radius:2px;margin-top:0.3rem}
  .dl-bar{height:100%;border-radius:2px;background:#4ade80;transition:width 0.5s ease}
  .dl-bar.done{background:#3b82f6}
  .dl-right{text-align:right;flex-shrink:0;min-width:55px}
  .dl-pct{font-size:0.8rem;font-weight:600}
  .dl-speed{font-size:0.6rem;color:#7a7a9a;margin-top:0.15rem}
  .dl-eta{font-size:0.6rem;color:#7a7a9a;margin-top:0.1rem}
  /* Widget grid — two-column for smaller panels */
  .widget-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
  @media(max-width:768px){.widget-grid{grid-template-columns:1fr}}
  /* Widget panel (shared by calendar, recent, requests, disk) */
  .w-panel{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;overflow:hidden}
  .w-header{display:flex;justify-content:space-between;align-items:center;padding:0.8rem 1.2rem;border-bottom:1px solid #2a2a4a}
  .w-header-title{font-size:0.85rem;font-weight:600}
  .w-header-sub{font-size:0.65rem;color:#7a7a9a}
  .w-empty{padding:2rem;text-align:center;color:#4a4a6a;font-size:0.85rem}
  .w-list{max-height:320px;overflow-y:auto}
  .w-item{display:flex;align-items:center;gap:0.8rem;padding:0.6rem 1.2rem;border-bottom:1px solid #1f1f35}
  .w-item:last-child{border-bottom:none}
  .w-item-icon{font-size:0.9rem;flex-shrink:0;width:20px;text-align:center}
  .w-item-info{flex:1;min-width:0}
  .w-item-title{font-size:0.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .w-item-sub{font-size:0.65rem;color:#7a7a9a;margin-top:0.15rem}
  .w-item-right{flex-shrink:0;text-align:right}
  /* Calendar date groups */
  .cal-date{font-size:0.65rem;font-weight:600;color:#7a7a9a;padding:0.5rem 1.2rem 0.3rem;text-transform:uppercase;letter-spacing:0.05em;background:#14142a}
  .cal-ep{color:#4ade80}
  .cal-movie{color:#e94560}
  /* Request status badges */
  .badge{font-size:0.6rem;font-weight:600;padding:0.15rem 0.5rem;border-radius:4px;text-transform:uppercase;letter-spacing:0.03em}
  .badge-pending{background:#f59e0b20;color:#f59e0b}
  .badge-approved{background:#3b82f620;color:#3b82f6}
  .badge-available{background:#4ade8020;color:#4ade80}
  .badge-declined{background:#ef444420;color:#ef4444}
  /* Disk gauge */
  .disk-gauge{padding:1.2rem;text-align:center}
  .disk-bar-wrap{width:100%;height:10px;background:#2a2a4a;border-radius:5px;margin:0.8rem 0}
  .disk-bar{height:100%;border-radius:5px;transition:width 0.5s ease}
  .disk-bar.ok{background:#4ade80}
  .disk-bar.warn{background:#f59e0b}
  .disk-bar.crit{background:#ef4444}
  .disk-label{font-size:0.8rem;font-weight:500}
  .disk-sub{font-size:0.7rem;color:#7a7a9a;margin-top:0.3rem}
</style></head>
<body>
  <div class="header"><h1><span>Media</span> Server</h1><p>Service dashboard <a href="/admin.html" style="color:#7a7a9a;font-size:0.85rem;margin-left:1rem;text-decoration:none;border:1px solid #2a2a4a;padding:0.2rem 0.6rem;border-radius:5px;transition:all 0.2s" onmouseover="this.style.borderColor='#3a3a5a';this.style.color='#e0e0e0'" onmouseout="this.style.borderColor='#2a2a4a';this.style.color='#7a7a9a'">Admin</a></p></div>
  <div class="content">
    <div id="app"></div>

    <!-- Downloads: qBittorrent -->
    <div class="section">
      <div class="section-title">Active Transfers</div>
      <div class="dl-panel">
        <div class="dl-header">
          <div class="dl-header-title">qBittorrent</div>
          <div class="dl-stats" id="dl-stats"></div>
        </div>
        <div id="dl-list"><div class="dl-empty">Loading...</div></div>
      </div>
    </div>

    <!-- Downloads: SABnzbd -->
    <div class="section">
      <div class="dl-panel">
        <div class="dl-header">
          <div class="dl-header-title">SABnzbd</div>
          <div class="dl-stats" id="sab-stats"></div>
        </div>
        <div id="sab-list"><div class="dl-empty">Loading...</div></div>
      </div>
    </div>

    <!-- Two-column widget grid -->
    <div class="section">
      <div class="widget-grid">

        <!-- Calendar -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Upcoming</div>
            <div class="w-header-sub" id="cal-sub"></div>
          </div>
          <div class="w-list" id="cal-list"><div class="w-empty">Loading...</div></div>
        </div>

        <!-- Recently Added -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Recently Added</div>
            <div class="w-header-sub" id="recent-sub"></div>
          </div>
          <div class="w-list" id="recent-list"><div class="w-empty">Loading...</div></div>
        </div>

        <!-- Jellyseerr Requests -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Requests</div>
            <div class="w-header-sub" id="req-sub"></div>
          </div>
          <div class="w-list" id="req-list"><div class="w-empty">Loading...</div></div>
        </div>

        <!-- Disk Space -->
        <div class="w-panel">
          <div class="w-header">
            <div class="w-header-title">Disk Space</div>
            <div class="w-header-sub" id="disk-sub"></div>
          </div>
          <div id="disk-content"><div class="w-empty">Loading...</div></div>
        </div>

      </div>
    </div>
  </div>
  <script>
    var h=location.hostname;
    var icons={
      Jellyseerr:'\uD83C\uDFAC',Jellyfin:'\u25B6\uFE0F',
      Sonarr:'\uD83D\uDCFA','Sonarr Anime':'\uD83C\uDF1F',
      Radarr:'\uD83C\uDFA5',Lidarr:'\uD83C\uDFB5',LazyLibrarian:'\uD83D\uDCDA',
      Prowlarr:'\uD83D\uDD0D',Bazarr:'\uD83D\uDCAC',Autobrr:'\u26A1',
      qBittorrent:'\u2B07\uFE0F',SABnzbd:'\uD83D\uDCE5',
      Navidrome:'\uD83C\uDFB6',Kavita:'\uD83D\uDCD6',TubeArchivist:'\uD83D\uDCF9',Immich:'\uD83D\uDCF7',Tdarr:'\uD83D\uDD04',
      Ollama:'\uD83E\uDDE0','Open WebUI':'\uD83D\uDCAC',Dozzle:'\uD83D\uDCDC',Beszel:'\uD83D\uDCCA',Scrutiny:'\uD83D\uDCBF',
      Gitea:'\uD83D\uDCBB','Uptime Kuma':'\uD83D\uDFE2'
    };
    var sections=[
      ["Watch & Request","cat-media",[
        [5055,"Jellyseerr","Request movies & TV"],
        [8096,"Jellyfin","Stream your library"],
        [4533,"Navidrome","Stream your music"],
        [5001,"Kavita","Read books & comics"],
        [8000,"TubeArchivist","YouTube archive"]
      ]],
      ["Downloads","cat-download",[
        [8081,"qBittorrent","Torrent client"],
        [8080,"SABnzbd","Usenet client"]
      ]],
      ["AI","cat-tools",[
        [3100,"Open WebUI","Chat with local LLMs"]
      ]],
      ["Photos","cat-tools",[
        [2283,"Immich","Photo management"]
      ]]
    ];

    // Build entire service grid as one string, assign once
    var gridHtml='';
    var allServices=[];
    sections.forEach(function(sec){
      gridHtml+='<div class="section"><div class="section-title">'+sec[0]+'</div><div class="grid">';
      sec[2].forEach(function(s){
        var ico=icons[s[1]]||'\u25CF';
        gridHtml+='<a href="http://'+h+':'+s[0]+'" class="card '+sec[1]+'">'
          +'<div class="icon">'+ico+'</div>'
          +'<div class="card-info"><div class="card-name">'+s[1]+'</div>'
          +'<div class="card-desc">'+s[2]+'</div>'
          +'<div class="card-port">:'+s[0]+'</div></div>'
          +'<div class="dot" id="d'+s[0]+'"></div></a>';
        allServices.push(s[0]);
      });
      gridHtml+='</div></div>';
    });
    document.getElementById("app").innerHTML=gridHtml;

    // Health checks — run on load and every 30s
    function checkHealth(){
      allServices.forEach(function(port){
        var d=document.getElementById("d"+port);
        if(!d)return;
        fetch("http://"+h+":"+port,{mode:"no-cors",signal:AbortSignal.timeout(3000)})
          .then(function(){d.className="dot up"})
          .catch(function(){d.className="dot down"});
      });
    }
    checkHealth();
    setInterval(checkHealth,30000);

    // ── Shared helpers ──
    function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
    function fmtSize(b){
      if(b<1024)return b+"B";
      if(b<1048576)return(b/1024).toFixed(1)+" KB";
      if(b<1073741824)return(b/1048576).toFixed(1)+" MB";
      return(b/1073741824).toFixed(1)+" GB";
    }
    function fmtSpeed(b){
      if(b<1024)return b+" B/s";
      if(b<1048576)return(b/1024).toFixed(0)+" KB/s";
      return(b/1048576).toFixed(1)+" MB/s";
    }
    function fmtEta(secs){
      if(secs<=0||secs>=8640000)return'';
      if(secs<60)return secs+'s';
      if(secs<3600)return Math.floor(secs/60)+'m';
      if(secs<86400)return Math.floor(secs/3600)+'h '+Math.floor((secs%3600)/60)+'m';
      return Math.floor(secs/86400)+'d '+Math.floor((secs%86400)/3600)+'h';
    }
    function isoDate(d){return d.toISOString().split('T')[0];}
    function shortDate(s){
      var d=new Date(s);
      var today=new Date();today.setHours(0,0,0,0);
      var diff=Math.floor((d-today)/86400000);
      if(diff===0)return'Today';
      if(diff===1)return'Tomorrow';
      return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
    }

    // ── qBittorrent Downloads ──
    function stateIcon(st){
      if(st==="downloading"||st==="forcedDL"||st==="metaDL")return['downloading','\u25BC'];
      if(st==="uploading"||st==="forcedUP"||st==="stalledUP"||st==="queuedUP")return['seeding','\u25B2'];
      if(st==="stalledDL"||st==="checkingDL")return['stalled','\u25CF'];
      if(st==="pausedDL"||st==="pausedUP")return['paused','\u275A\u275A'];
      return['stalled','\u25CF'];
    }
    function stateLabel(st){
      if(st==="downloading"||st==="forcedDL")return"Downloading";
      if(st==="metaDL")return"Metadata";
      if(st==="uploading"||st==="forcedUP")return"Seeding";
      if(st==="stalledUP"||st==="queuedUP")return"Seeding (idle)";
      if(st==="stalledDL")return"Stalled";
      if(st==="pausedDL")return"Paused";
      if(st==="pausedUP")return"Complete";
      if(st==="checkingDL"||st==="checkingUP"||st==="checkingResumeData")return"Checking";
      if(st==="queuedDL")return"Queued";
      if(st==="moving")return"Moving";
      return st;
    }
    function refreshDownloads(){
      fetch("/api/qbt/torrents/info").then(function(r){return r.json()}).then(function(torrents){
        var totalDown=0,totalUp=0;
        torrents.forEach(function(t){totalDown+=t.dlspeed;totalUp+=t.upspeed;});
        var statsEl=document.getElementById("dl-stats");
        statsEl.innerHTML='<span class="down">\u25BC '+fmtSpeed(totalDown)+'</span><span class="up">\u25B2 '+fmtSpeed(totalUp)+'</span><span>'+torrents.length+' torrent'+(torrents.length!==1?'s':'')+'</span>';
        var list=document.getElementById("dl-list");
        if(!torrents.length){list.innerHTML='<div class="dl-empty">No active torrents</div>';return;}
        torrents.sort(function(a,b){
          var aD=a.state.indexOf("DL")!==-1||a.state==="downloading"?0:1;
          var bD=b.state.indexOf("DL")!==-1||b.state==="downloading"?0:1;
          if(aD!==bD)return aD-bD;
          return a.progress-b.progress;
        });
        var html="";
        torrents.forEach(function(t){
          var si=stateIcon(t.state);
          var pct=Math.floor(t.progress*100);
          var barClass=pct>=100?"dl-bar done":"dl-bar";
          var speedTxt="";
          if(t.dlspeed>0)speedTxt="\u25BC "+fmtSpeed(t.dlspeed);
          else if(t.upspeed>0)speedTxt="\u25B2 "+fmtSpeed(t.upspeed);
          var eta=t.eta?fmtEta(t.eta):'';
          html+='<div class="dl-item">';
          html+='<div class="dl-icon '+si[0]+'">'+si[1]+'</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(t.name)+'">'+esc(t.name)+'</div>';
          html+='<div class="dl-meta"><span>'+stateLabel(t.state)+'</span><span>'+fmtSize(t.size)+'</span><span>'+t.num_seeds+' seeds / '+t.num_leechs+' peers</span>'+(t.category?'<span>'+esc(t.category)+'</span>':'')+'</div>';
          html+='<div class="dl-bar-wrap"><div class="'+barClass+'" style="width:'+pct+'%"></div></div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct">'+pct+'%</div><div class="dl-speed">'+speedTxt+'</div>'+(eta?'<div class="dl-eta">'+eta+'</div>':'')+'</div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("dl-list").innerHTML='<div class="dl-empty">Cannot connect to qBittorrent</div>';
      });
    }
    refreshDownloads();
    setInterval(refreshDownloads,5000);

    // ── SABnzbd Downloads ──
    function refreshSab(){
      Promise.all([
        fetch('/api/sabnzbd/?mode=queue&output=json').then(function(r){return r.json()}),
        fetch('/api/sabnzbd/?mode=history&output=json&limit=5').then(function(r){return r.json()})
      ]).then(function(results){
        var queue=results[0].queue||{};
        var history=results[1].history||{};
        var slots=queue.slots||[];
        var histSlots=(history.slots||[]).slice(0,5);
        var statsEl=document.getElementById("sab-stats");
        var speed=queue.speed||'0';
        var left=queue.timeleft||'';
        statsEl.innerHTML='<span class="down">\u25BC '+esc(speed)+'</span>'+(left?'<span>ETA: '+esc(left)+'</span>':'')+'<span>'+slots.length+' active</span>';
        var list=document.getElementById("sab-list");
        if(!slots.length&&!histSlots.length){list.innerHTML='<div class="dl-empty">No active downloads</div>';return;}
        var html='';
        slots.forEach(function(s){
          var pct=Math.round(parseFloat(s.percentage)||0);
          html+='<div class="dl-item">';
          html+='<div class="dl-icon downloading">\u25BC</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(s.filename)+'">'+esc(s.filename)+'</div>';
          html+='<div class="dl-meta"><span>Downloading</span><span>'+esc(s.size)+'</span>'+(s.cat?'<span>'+esc(s.cat)+'</span>':'')+'</div>';
          html+='<div class="dl-bar-wrap"><div class="dl-bar" style="width:'+pct+'%"></div></div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct">'+pct+'%</div><div class="dl-speed">'+esc(s.timeleft||'')+'</div></div>';
          html+='</div>';
        });
        histSlots.forEach(function(s){
          var ok=s.status==='Completed';
          html+='<div class="dl-item">';
          html+='<div class="dl-icon '+(ok?'seeding':'stalled')+'">'+(ok?'\u2714':'\u2716')+'</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(s.name)+'">'+esc(s.name)+'</div>';
          html+='<div class="dl-meta"><span>'+esc(s.status)+'</span><span>'+esc(s.size)+'</span>'+(s.category?'<span>'+esc(s.category)+'</span>':'')+'</div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct" style="color:'+(ok?'#4ade80':'#ef4444')+'">'+(ok?'Done':'Fail')+'</div></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("sab-list").innerHTML='<div class="dl-empty">Cannot connect to SABnzbd</div>';
      });
    }
    refreshSab();
    setInterval(refreshSab,5000);

    // ── Calendar (Sonarr + Sonarr Anime + Radarr) ──
    function refreshCalendar(){
      var today=new Date();
      var end7=new Date(today);end7.setDate(end7.getDate()+7);
      var end90=new Date(today);end90.setDate(end90.getDate()+90);
      var start=isoDate(today),endW=isoDate(end7),endM=isoDate(end90);
      Promise.all([
        fetch('/api/sonarr/calendar?start='+start+'&end='+endW).then(function(r){return r.json()}).catch(function(){return[]}),
        fetch('/api/sonarr-anime/calendar?start='+start+'&end='+endW).then(function(r){return r.json()}).catch(function(){return[]}),
        fetch('/api/radarr/calendar?start='+start+'&end='+endM).then(function(r){return r.json()}).catch(function(){return[]})
      ]).then(function(results){
        var items=[];
        results[0].forEach(function(ep){
          items.push({date:ep.airDateUtc||ep.airDate||'',title:ep.series?ep.series.title:'Unknown',sub:'S'+String(ep.seasonNumber).padStart(2,'0')+'E'+String(ep.episodeNumber).padStart(2,'0')+' - '+(ep.title||''),type:'ep'});
        });
        results[1].forEach(function(ep){
          items.push({date:ep.airDateUtc||ep.airDate||'',title:ep.series?ep.series.title:'Unknown',sub:'S'+String(ep.seasonNumber).padStart(2,'0')+'E'+String(ep.episodeNumber).padStart(2,'0')+' - '+(ep.title||''),type:'ep'});
        });
        results[2].forEach(function(m){
          items.push({date:m.inCinemas||m.digitalRelease||m.physicalRelease||'',title:m.title||'Unknown',sub:m.year?String(m.year):'',type:'movie'});
        });
        items.sort(function(a,b){return(a.date||'').localeCompare(b.date||'')});
        document.getElementById("cal-sub").textContent=items.length+' upcoming';
        var list=document.getElementById("cal-list");
        if(!items.length){list.innerHTML='<div class="w-empty">Nothing upcoming</div>';return;}
        var html='',lastDate='';
        items.forEach(function(it){
          var d=it.date?it.date.split('T')[0]:'';
          if(d!==lastDate){html+='<div class="cal-date">'+shortDate(d)+'</div>';lastDate=d;}
          html+='<div class="w-item">';
          html+='<div class="w-item-icon '+(it.type==='ep'?'cal-ep':'cal-movie')+'">'+(it.type==='ep'?'\uD83D\uDCFA':'\uD83C\uDFA5')+'</div>';
          html+='<div class="w-item-info"><div class="w-item-title">'+esc(it.title)+'</div><div class="w-item-sub">'+esc(it.sub)+'</div></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("cal-list").innerHTML='<div class="w-empty">Cannot load calendar</div>';
      });
    }
    refreshCalendar();
    setInterval(refreshCalendar,300000);

    // ── Recently Added (Jellyfin) ──
    function refreshRecent(){
      fetch('/api/jellyfin/Items?SortBy=DateCreated&SortOrder=Descending&Limit=10&Recursive=true&IncludeItemTypes=Movie,Series&Fields=DateCreated').then(function(r){return r.json()}).then(function(data){
        var items=(data&&data.Items)||[];
        document.getElementById("recent-sub").textContent=items.length+' items';
        var list=document.getElementById("recent-list");
        if(!items.length){list.innerHTML='<div class="w-empty">No recent media</div>';return;}
        var html='';
        items.forEach(function(it){
          var type=it.Type||'';
          var ico=type==='Movie'?'\uD83C\uDFA5':type==='Series'?'\uD83D\uDCFA':'\uD83C\uDFB5';
          var sub=type;
          if(it.ProductionYear)sub+=' ('+it.ProductionYear+')';
          if(it.DateCreated){
            var d=new Date(it.DateCreated);
            sub+=' - added '+d.toLocaleDateString();
          }
          html+='<div class="w-item">';
          html+='<div class="w-item-icon">'+ico+'</div>';
          html+='<div class="w-item-info"><div class="w-item-title">'+esc(it.Name||'Unknown')+'</div><div class="w-item-sub">'+esc(sub)+'</div></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("recent-list").innerHTML='<div class="w-empty">Cannot connect to Jellyfin</div>';
      });
    }
    refreshRecent();
    setInterval(refreshRecent,120000);

    // ── Jellyseerr Requests ──
    function refreshRequests(){
      fetch('/api/jellyseerr/request?take=10&sort=added&skip=0').then(function(r){return r.json()}).then(function(data){
        var results=data.results||[];
        document.getElementById("req-sub").textContent=(data.pageInfo?data.pageInfo.results:results.length)+' total';
        var list=document.getElementById("req-list");
        if(!results.length){list.innerHTML='<div class="w-empty">No requests</div>';return;}
        var html='';
        results.forEach(function(req){
          var media=req.media||{};
          var title=media.title||media.name||(req.type==='movie'?'Movie':'TV Show');
          // Try to get title from mediaInfo
          if(req.type==='movie'&&req.media&&req.media.title)title=req.media.title;
          if(req.type==='tv'&&req.media&&req.media.name)title=req.media.name;
          var status=req.status;
          var badgeClass='badge-pending',badgeText='Pending';
          if(status===2){badgeClass='badge-approved';badgeText='Approved';}
          else if(status===3){badgeClass='badge-declined';badgeText='Declined';}
          if(media.status===5){badgeClass='badge-available';badgeText='Available';}
          else if(media.status===4){badgeClass='badge-approved';badgeText='Processing';}
          var ico=req.type==='movie'?'\uD83C\uDFA5':'\uD83D\uDCFA';
          var sub=req.type==='movie'?'Movie':'TV Show';
          if(req.requestedBy&&req.requestedBy.displayName)sub+=' - '+req.requestedBy.displayName;
          html+='<div class="w-item">';
          html+='<div class="w-item-icon">'+ico+'</div>';
          html+='<div class="w-item-info"><div class="w-item-title">'+esc(title)+'</div><div class="w-item-sub">'+esc(sub)+'</div></div>';
          html+='<div class="w-item-right"><span class="badge '+badgeClass+'">'+badgeText+'</span></div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("req-list").innerHTML='<div class="w-empty">Cannot connect to Jellyseerr</div>';
      });
    }
    refreshRequests();
    setInterval(refreshRequests,30000);

    // ── Disk Space (via qBittorrent sync/maindata) ──
    function refreshDisk(){
      fetch('/api/qbt/sync/maindata').then(function(r){return r.json()}).then(function(data){
        var state=data.server_state||{};
        var free=state.free_space_on_disk||0;
        var el=document.getElementById("disk-content");
        // qBittorrent only reports free space, not total — show free space as a gauge
        // Estimate usage: fetch alldata via preferences for save_path info
        var freeGB=(free/1073741824).toFixed(1);
        document.getElementById("disk-sub").textContent='Downloads drive';
        var cls='ok';
        if(free<53687091200)cls='warn'; // <50GB
        if(free<10737418240)cls='crit'; // <10GB
        el.innerHTML='<div class="disk-gauge">'
          +'<div class="disk-label">'+freeGB+' GB free</div>'
          +'<div class="disk-bar-wrap"><div class="disk-bar '+cls+'" style="width:'+Math.min(100,Math.max(5,free/1099511627776*100))+'%"></div></div>'
          +'<div class="disk-sub">'+((free<53687091200)?'Low disk space warning':'Healthy')+'</div>'
          +'</div>';
      }).catch(function(){
        document.getElementById("disk-content").innerHTML='<div class="w-empty">Cannot read disk info</div>';
      });
    }
    refreshDisk();
    setInterval(refreshDisk,60000);
  </script>
</body></html>

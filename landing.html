<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Media Server</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127916;</text></svg>">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,sans-serif;background:#0f0f1a;color:#e0e0e0;min-height:100vh}
  .header{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);padding:2rem 2rem 1.5rem;border-bottom:1px solid #2a2a4a}
  .header h1{font-size:1.6rem;font-weight:700;letter-spacing:-0.02em}
  .header h1 span{color:#e94560}
  .header p{color:#7a7a9a;font-size:0.85rem;margin-top:0.3rem}
  .content{max-width:1200px;margin:0 auto;padding:1.5rem 2rem 3rem}
  .section{margin-bottom:2rem}
  .section-title{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:#7a7a9a;margin-bottom:0.75rem;padding-left:0.25rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.75rem}
  .card{display:flex;align-items:center;gap:1rem;padding:1rem 1.2rem;background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;color:#e0e0e0;text-decoration:none;transition:all 0.2s ease}
  .card:hover{background:#1e2240;border-color:#3a3a5a;transform:translateY(-1px)}
  .icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
  .card-info{flex:1;min-width:0}
  .card-name{font-size:0.95rem;font-weight:600}
  .card-desc{font-size:0.75rem;color:#7a7a9a;margin-top:0.15rem}
  .card-port{font-size:0.65rem;color:#e94560;font-weight:500;margin-top:0.2rem}
  .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#3a3a5a;transition:background 0.3s ease}
  .dot.up{background:#4ade80}
  .dot.down{background:#ef4444}
  .cat-media .icon{background:#e9456020;color:#e94560}
  .cat-manage .icon{background:#3b82f620;color:#3b82f6}
  .cat-download .icon{background:#f59e0b20;color:#f59e0b}
  .cat-tools .icon{background:#8b5cf620;color:#8b5cf6}
  /* Downloads panel */
  .dl-panel{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:10px;overflow:hidden}
  .dl-header{display:flex;justify-content:space-between;align-items:center;padding:0.8rem 1.2rem;border-bottom:1px solid #2a2a4a}
  .dl-header-title{font-size:0.85rem;font-weight:600}
  .dl-stats{font-size:0.7rem;color:#7a7a9a}
  .dl-stats span{margin-left:1rem}
  .dl-stats .down{color:#4ade80}
  .dl-stats .up{color:#3b82f6}
  .dl-empty{padding:2rem;text-align:center;color:#4a4a6a;font-size:0.85rem}
  .dl-item{display:flex;align-items:center;gap:0.8rem;padding:0.7rem 1.2rem;border-bottom:1px solid #1f1f35}
  .dl-item:last-child{border-bottom:none}
  .dl-icon{font-size:0.9rem;flex-shrink:0;width:20px;text-align:center}
  .dl-icon.downloading{color:#4ade80}
  .dl-icon.seeding{color:#3b82f6}
  .dl-icon.stalled{color:#f59e0b}
  .dl-icon.paused{color:#7a7a9a}
  .dl-info{flex:1;min-width:0}
  .dl-name{font-size:0.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dl-meta{display:flex;flex-wrap:wrap;gap:0.5rem 1rem;font-size:0.65rem;color:#7a7a9a;margin-top:0.25rem}
  .dl-bar-wrap{width:100%;height:3px;background:#2a2a4a;border-radius:2px;margin-top:0.3rem}
  .dl-bar{height:100%;border-radius:2px;background:#4ade80;transition:width 0.5s ease}
  .dl-bar.done{background:#3b82f6}
  .dl-right{text-align:right;flex-shrink:0;min-width:55px}
  .dl-pct{font-size:0.8rem;font-weight:600}
  .dl-speed{font-size:0.6rem;color:#7a7a9a;margin-top:0.15rem}
  .dl-eta{font-size:0.6rem;color:#7a7a9a;margin-top:0.1rem}
</style></head>
<body>
  <div class="header"><h1><span>Media</span> Server</h1><p>Service dashboard</p></div>
  <div class="content">
    <div id="app"></div>
    <div class="section">
      <div class="section-title">Active Transfers</div>
      <div class="dl-panel">
        <div class="dl-header">
          <div class="dl-header-title">qBittorrent</div>
          <div class="dl-stats" id="dl-stats"></div>
        </div>
        <div id="dl-list"><div class="dl-empty">Loading...</div></div>
      </div>
    </div>
  </div>
  <script>
    var h=location.hostname;
    var icons={
      Jellyseerr:'\uD83C\uDFAC',Jellyfin:'\u25B6\uFE0F',
      Sonarr:'\uD83D\uDCFA','Sonarr Anime':'\uD83C\uDF1F',
      Radarr:'\uD83C\uDFA5',Prowlarr:'\uD83D\uDD0D',Bazarr:'\uD83D\uDCAC',
      qBittorrent:'\u2B07\uFE0F',SABnzbd:'\uD83D\uDCE5',Organizr:'\uD83D\uDCCB'
    };
    var sections=[
      ["Watch & Request","cat-media",[
        [5055,"Jellyseerr","Request movies & TV"],
        [8096,"Jellyfin","Stream your library"]
      ]],
      ["Library Management","cat-manage",[
        [8989,"Sonarr","TV show automation"],
        [8990,"Sonarr Anime","Anime series"],
        [7878,"Radarr","Movie automation"],
        [9696,"Prowlarr","Indexer management"],
        [6767,"Bazarr","Subtitle downloads"]
      ]],
      ["Downloads","cat-download",[
        [8081,"qBittorrent","Torrent client"],
        [8080,"SABnzbd","Usenet client"]
      ]],
      ["Tools","cat-tools",[
        [9090,"Organizr","Unified dashboard"]
      ]]
    ];

    // Build entire service grid as one string, assign once
    var gridHtml='';
    var allServices=[];
    sections.forEach(function(sec){
      gridHtml+='<div class="section"><div class="section-title">'+sec[0]+'</div><div class="grid">';
      sec[2].forEach(function(s){
        var ico=icons[s[1]]||'\u25CF';
        gridHtml+='<a href="http://'+h+':'+s[0]+'" class="card '+sec[1]+'">'
          +'<div class="icon">'+ico+'</div>'
          +'<div class="card-info"><div class="card-name">'+s[1]+'</div>'
          +'<div class="card-desc">'+s[2]+'</div>'
          +'<div class="card-port">:'+s[0]+'</div></div>'
          +'<div class="dot" id="d'+s[0]+'"></div></a>';
        allServices.push(s[0]);
      });
      gridHtml+='</div></div>';
    });
    document.getElementById("app").innerHTML=gridHtml;

    // Health checks â€” run on load and every 30s
    function checkHealth(){
      allServices.forEach(function(port){
        var d=document.getElementById("d"+port);
        if(!d)return;
        fetch("http://"+h+":"+port,{mode:"no-cors",signal:AbortSignal.timeout(3000)})
          .then(function(){d.className="dot up"})
          .catch(function(){d.className="dot down"});
      });
    }
    checkHealth();
    setInterval(checkHealth,30000);

    // Downloads widget
    function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
    function fmtSize(b){
      if(b<1024)return b+"B";
      if(b<1048576)return(b/1024).toFixed(1)+" KB";
      if(b<1073741824)return(b/1048576).toFixed(1)+" MB";
      return(b/1073741824).toFixed(1)+" GB";
    }
    function fmtSpeed(b){
      if(b<1024)return b+" B/s";
      if(b<1048576)return(b/1024).toFixed(0)+" KB/s";
      return(b/1048576).toFixed(1)+" MB/s";
    }
    function fmtEta(secs){
      if(secs<=0||secs>=8640000)return'';
      if(secs<60)return secs+'s';
      if(secs<3600)return Math.floor(secs/60)+'m';
      if(secs<86400)return Math.floor(secs/3600)+'h '+Math.floor((secs%3600)/60)+'m';
      return Math.floor(secs/86400)+'d '+Math.floor((secs%86400)/3600)+'h';
    }
    function stateIcon(st){
      if(st==="downloading"||st==="forcedDL"||st==="metaDL")return['downloading','\u25BC'];
      if(st==="uploading"||st==="forcedUP"||st==="stalledUP"||st==="queuedUP")return['seeding','\u25B2'];
      if(st==="stalledDL"||st==="checkingDL")return['stalled','\u25CF'];
      if(st==="pausedDL"||st==="pausedUP")return['paused','\u275A\u275A'];
      return['stalled','\u25CF'];
    }
    function stateLabel(st){
      if(st==="downloading"||st==="forcedDL")return"Downloading";
      if(st==="metaDL")return"Metadata";
      if(st==="uploading"||st==="forcedUP")return"Seeding";
      if(st==="stalledUP"||st==="queuedUP")return"Seeding (idle)";
      if(st==="stalledDL")return"Stalled";
      if(st==="pausedDL")return"Paused";
      if(st==="pausedUP")return"Complete";
      if(st==="checkingDL"||st==="checkingUP"||st==="checkingResumeData")return"Checking";
      if(st==="queuedDL")return"Queued";
      if(st==="moving")return"Moving";
      return st;
    }
    function refreshDownloads(){
      fetch("/api/qbt/torrents/info").then(function(r){return r.json()}).then(function(torrents){
        var totalDown=0,totalUp=0;
        torrents.forEach(function(t){totalDown+=t.dlspeed;totalUp+=t.upspeed;});
        var statsEl=document.getElementById("dl-stats");
        statsEl.innerHTML='<span class="down">\u25BC '+fmtSpeed(totalDown)+'</span><span class="up">\u25B2 '+fmtSpeed(totalUp)+'</span><span>'+torrents.length+' torrent'+(torrents.length!==1?'s':'')+'</span>';
        var list=document.getElementById("dl-list");
        if(!torrents.length){list.innerHTML='<div class="dl-empty">No active torrents</div>';return;}
        // Sort: downloading first, then by progress
        torrents.sort(function(a,b){
          var aD=a.state.indexOf("DL")!==-1||a.state==="downloading"?0:1;
          var bD=b.state.indexOf("DL")!==-1||b.state==="downloading"?0:1;
          if(aD!==bD)return aD-bD;
          return a.progress-b.progress;
        });
        var html="";
        torrents.forEach(function(t){
          var si=stateIcon(t.state);
          var pct=Math.floor(t.progress*100);
          var barClass=pct>=100?"dl-bar done":"dl-bar";
          var speedTxt="";
          if(t.dlspeed>0)speedTxt="\u25BC "+fmtSpeed(t.dlspeed);
          else if(t.upspeed>0)speedTxt="\u25B2 "+fmtSpeed(t.upspeed);
          var eta=t.eta?fmtEta(t.eta):'';
          html+='<div class="dl-item">';
          html+='<div class="dl-icon '+si[0]+'">'+si[1]+'</div>';
          html+='<div class="dl-info">';
          html+='<div class="dl-name" title="'+esc(t.name)+'">'+esc(t.name)+'</div>';
          html+='<div class="dl-meta"><span>'+stateLabel(t.state)+'</span><span>'+fmtSize(t.size)+'</span><span>'+t.num_seeds+' seeds / '+t.num_leechs+' peers</span>'+(t.category?'<span>'+esc(t.category)+'</span>':'')+'</div>';
          html+='<div class="dl-bar-wrap"><div class="'+barClass+'" style="width:'+pct+'%"></div></div>';
          html+='</div>';
          html+='<div class="dl-right"><div class="dl-pct">'+pct+'%</div><div class="dl-speed">'+speedTxt+'</div>'+(eta?'<div class="dl-eta">'+eta+'</div>':'')+'</div>';
          html+='</div>';
        });
        list.innerHTML=html;
      }).catch(function(){
        document.getElementById("dl-list").innerHTML='<div class="dl-empty">Cannot connect to qBittorrent</div>';
      });
    }
    refreshDownloads();
    setInterval(refreshDownloads,5000);
  </script>
</body></html>
